// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---

enum Role {
  SUPER_ADMIN
  ADMIN
  DOCTOR
  USER
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

// Keep this for backward compatibility if old data exists
enum SlotType {
  FREE
  PAID
}

// ✅ THIS WAS MISSING - ADDED HERE
enum SlotPaymentMode {
  ONLINE
  OFFLINE
  FREE
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  CANCELLED
}

enum DoctorSpeciality {
  DENTIST
  CARDIOLOGIST
  NEUROLOGIST
  ORTHOPEDIC
  GYNECOLOGIST
  PEDIATRICIAN
  DERMATOLOGIST
  OPHTHALMOLOGIST
  GENERAL_PHYSICIAN
  OTHER
}

enum BookingSection {
  DENTAL
  CARDIAC
  NEUROLOGY
  ORTHOPEDICS
  GYNECOLOGY
  PEDIATRICS
  DERMATOLOGY
  OPHTHALMOLOGY
  GENERAL
  OTHER
}

// --- MODELS ---

model PaymentGateway {
  id            String    @id @default(uuid())
  name          String
  apiKey        String?
  secret        String?
  webhookSecret String?
  isActive      Boolean   @default(true)
  clinicId      String
  createdAt     DateTime  @default(now())
  deletedAt     DateTime? // ✅ Soft Delete

  clinic   Clinic    @relation(fields: [clinicId], references: [id])
  payments Payment[]

  @@unique([clinicId, name])
  @@map("payment_gateways")
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String
  name      String
  phone     String?
  avatar    String?
  role      Role
  clinicId  String?
  doctorId  String?   @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // ✅ Soft Delete

  clinic       Clinic?       @relation("ClinicAdmins", fields: [clinicId], references: [id])
  doctor       Doctor?       @relation("DoctorUser", fields: [doctorId], references: [id])
  appointments Appointment[]
  
  reviews       Review[]
  auditLogs     AuditLog[] 

  @@map("user")
}

model Clinic {
  id             String   @id @default(uuid())
  slug           String   @unique
  name           String
  logo           String?
  banner         String?
  address        String
  city           String
  pincode        String
  timings        Json
  details        String?
  accountNumber  String
  ifscCode       String
  bankName       String
  
  // Fields for Super Admin Control
  isActive       Boolean  @default(true)
  allowAuditView Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? // ✅ Soft Delete

  admins       User[]           @relation("ClinicAdmins")
  doctors      Doctor[]
  appointments Appointment[]
  slots        Slot[]
  payments     Payment[]
  gateways     PaymentGateway[]
  auditLogs    AuditLog[]
  linkClicks   Int     @default(0)

  @@map("clinics")
}

model Doctor {
  id         String           @id @default(uuid())
  slug       String           @unique
  name       String
  avatar     String?
  speciality DoctorSpeciality
  phone      String
  experience Int
  clinicId   String
  isActive   Boolean          @default(true)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  deletedAt  DateTime?        // ✅ Soft Delete

  clinic       Clinic       @relation(fields: [clinicId], references: [id])
  user         User?        @relation("DoctorUser")
  appointments Appointment[]
  slots        Slot[]
  payments     Payment[]
  reviews      Review[]

  @@map("doctors")
}

model Slot {
  id          String            @id @default(uuid())
  doctorId    String
  clinicId    String
  date        DateTime
  time        String
  duration    Int               @default(30)
  type        SlotType          @default(FREE)
  price       Decimal           @default(0)
  status      AppointmentStatus @default(PENDING)
  createdAt   DateTime          @default(now())
  deletedAt   DateTime?         // ✅ Soft Delete
  
  // ✅ NOW LINKED TO THE ENUM DEFINED ABOVE
  paymentMode SlotPaymentMode   @default(ONLINE)

  doctor       Doctor       @relation(fields: [doctorId], references: [id])
  clinic       Clinic       @relation(fields: [clinicId], references: [id])
  appointments Appointment[]

  @@unique([doctorId, date, time])
  @@map("slots")
}

model Appointment {
  id           String            @id @default(uuid())
  slug         String            @unique
  userId       String
  doctorId     String
  clinicId     String
  slotId       String            @unique
  section      BookingSection
  status       AppointmentStatus @default(PENDING)
  paymentId    String?
  notes        String?
  symptoms     String?
  prescription String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  deletedAt    DateTime?         // ✅ Soft Delete

  user    User   @relation(fields: [userId], references: [id])
  doctor  Doctor @relation(fields: [doctorId], references: [id])
  clinic  Clinic @relation(fields: [clinicId], references: [id])
  slot    Slot   @relation(fields: [slotId], references: [id])
  payment Payment?

  logs    AppointmentLog[]
  review  Review?

  @@map("appointments")
}

model Payment {
  id           String        @id @default(uuid())
  appointmentId String       @unique
  clinicId     String
  doctorId     String
  gatewayId    String
  amount       Decimal
  status       PaymentStatus
  gatewayRefId String?
  createdAt    DateTime      @default(now())

  appointment Appointment    @relation(fields: [appointmentId], references: [id])
  clinic      Clinic         @relation(fields: [clinicId], references: [id])
  doctor      Doctor         @relation(fields: [doctorId], references: [id])
  gateway     PaymentGateway @relation(fields: [gatewayId], references: [id])

  @@map("payments")
}

// --- HISTORY & LOGS ---

model AppointmentLog {
  id            String   @id @default(uuid())
  appointmentId String
  oldDate       DateTime
  oldTime       String
  newDate       DateTime
  newTime       String
  reason        String?
  changedBy     String
  createdAt     DateTime @default(now())

  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@map("appointment_logs")
}

model Review {
  id            String   @id @default(uuid())
  appointmentId String   @unique
  doctorId      String
  userId        String
  rating        Int
  comment       String?
  createdAt     DateTime @default(now())
  deletedAt     DateTime? // ✅ Soft Delete

  appointment   Appointment @relation(fields: [appointmentId], references: [id])
  doctor        Doctor      @relation(fields: [doctorId], references: [id])
  user          User        @relation(fields: [userId], references: [id])

  @@map("reviews")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  clinicId  String?  
  action    String
  entity    String
  entityId  String?
  details   Json?
  ipAddress String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
  clinic    Clinic?  @relation(fields: [clinicId], references: [id]) 

  @@map("audit_logs")
}
