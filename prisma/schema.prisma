generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Plan {
  id                  String         @id @default(uuid())
  name                String
  slug                String         @unique
  priceMonthly        Decimal
  currency            String         @default("INR")
  maxDoctors          Int            @default(1)
  maxBookingsPerMonth Int            @default(100)
  allowOnlinePayments Boolean        @default(false)
  allowCustomBranding Boolean        @default(false)
  isActive            Boolean        @default(true)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  deletedAt           DateTime?
  enableAuditLogs     Boolean        @default(true)
  enableGoogleReviews Boolean        @default(false)
  enableBulkSlots     Boolean        @default(true)
  enableExports       Boolean        @default(true)
  enableReviews       Boolean        @default(true)
  durationDays        Int?
  isTrial             Boolean        @default(false)
  trialDays           Int?
  subscriptions       Subscription[]

  @@map("plans")
}

model Subscription {
  id                    String             @id @default(uuid())
  clinicId              String             @unique
  planId                String
  status                SubscriptionStatus @default(ACTIVE)
  startDate             DateTime           @default(now())
  endDate               DateTime?
  nextBillingDate       DateTime?
  gatewaySubscriptionId String?
  gatewayCustomerId     String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  deletedAt             DateTime?
  durationDays          Int?
  isTrial               Boolean            @default(false)
  maxBookingsPerPeriod  Int?
  maxDoctors            Int?
  priceAtPurchase       Decimal?
  trialDays             Int?
  clinic                Clinic             @relation(fields: [clinicId], references: [id])
  plan                  Plan               @relation(fields: [planId], references: [id])

  @@map("subscriptions")
}

model PaymentGateway {
  id            String    @id @default(uuid())
  name          String
  apiKey        String?
  secret        String?
  webhookSecret String?
  isActive      Boolean   @default(true)
  clinicId      String
  createdAt     DateTime  @default(now())
  deletedAt     DateTime?
  clinic        Clinic    @relation(fields: [clinicId], references: [id])
  payments      Payment[]

  @@unique([clinicId, name])
  @@map("payment_gateways")
}

model User {
  id           String        @id @default(uuid())
  email        String        @unique
  password     String
  name         String
  phone        String?
  avatar       String?
  role         Role
  clinicId     String?
  doctorId     String?       @unique
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  deletedAt    DateTime?
  appointments Appointment[]
  auditLogs    AuditLog[]
  reviews      Review[]
  clinic       Clinic?       @relation("ClinicAdmins", fields: [clinicId], references: [id])
  doctor       Doctor?       @relation("DoctorUser", fields: [doctorId], references: [id])

  @@map("user")
}

model Clinic {
  id                     String           @id @default(uuid())
  slug                   String           @unique
  name                   String
  logo                   String?
  banner                 String?
  address                String
  city                   String
  pincode                String
  timings                Json
  details                String?
  accountNumber          String?
ifscCode               String?
bankName               String?
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt
  allowAuditView         Boolean          @default(false)
  isActive               Boolean          @default(true)
    isPublic    Boolean  @default(true) 
  deletedAt              DateTime?
  linkClicks             Int              @default(0)
  googleMapsUrl          String?
  googlePlaceId          String?
  googleReviewsEmbedCode String?
  googleRating           Decimal?
  googleReviewsCache     Json?
  googleTotalReviews     Int?
  lastGoogleSync         DateTime?
  phone                  String           @default("0000000000")
  appointments           Appointment[]
  auditLogs              AuditLog[]
  doctors                Doctor[]
  gateways               PaymentGateway[]
  payments               Payment[]
  slots                  Slot[]
  subscription           Subscription?
  admins                 User[]           @relation("ClinicAdmins")

  @@map("clinics")
}

model Doctor {
  id           String   @id @default(uuid())
  slug         String   @unique
  name         String
  avatar       String?
  
  // 2. ❌ Remove this line:
  // speciality DoctorSpeciality

  // 3. ✅ Add these lines to link to the new table:
  specialityId String?
  speciality   Speciality? @relation(fields: [specialityId], references: [id])

  phone        String
  experience   Int
  clinicId     String
  isActive     Boolean  @default(true)
  
  // ... rest of your fields (appointments, clinic, etc.) remain the same
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?
  appointments Appointment[]
  clinic       Clinic   @relation(fields: [clinicId], references: [id])
  payments     Payment[]
  reviews      Review[]
  slots        Slot[]
  user         User?    @relation("DoctorUser")

  @@map("doctors")
}

model Slot {
  id           String            @id @default(uuid())
  doctorId     String
  clinicId     String
  date         DateTime
  time         String
  isBlocked     Boolean  @default(false)
  blockedReason String?
  blockedBy     String?
  blockedAt     DateTime?
  duration     Int               @default(30)
  type         SlotType          @default(FREE)
  price        Decimal           @default(0)
  status       AppointmentStatus @default(PENDING_PAYMENT)
  createdAt    DateTime          @default(now())
  deletedAt    DateTime?
  paymentMode  SlotPaymentMode   @default(ONLINE)
  kind         String            @default("APPOINTMENT")
  appointments Appointment?
  clinic       Clinic            @relation(fields: [clinicId], references: [id])
  doctor       Doctor            @relation(fields: [doctorId], references: [id])

  @@unique([doctorId, date, time])
  @@map("slots")
}

model Appointment {
  id                  String               @id @default(uuid())
  slug                String               @unique
  userId              String
  doctorId            String
  clinicId            String
  slotId              String               @unique
  section             BookingSection
  status              AppointmentStatus    @default(PENDING_PAYMENT)
  paymentId           String?
  notes               String?
  symptoms            String?
   financialStatus        String?             // "PAY_DIFFERENCE" | "REFUND_AT_CLINIC" | "NO_CHANGE"
  diffAmount             Decimal?            // store positive difference
  // relations
  prescription        String?
  adminNote String?  @db.Text
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  deletedAt           DateTime?
  cancelReason        String?
  cancelledBy         CancellationActor?
  amount              Decimal?
  orderId             String?
  paymentExpiry       DateTime?
  paymentStatus       PaymentStatus        @default(PENDING)
  logs                AppointmentLog[]
  clinic              Clinic               @relation(fields: [clinicId], references: [id])
  doctor              Doctor               @relation(fields: [doctorId], references: [id])
  slot                Slot                 @relation(fields: [slotId], references: [id])
  user                User                 @relation(fields: [userId], references: [id])
  cancellationRequest CancellationRequest?
  payment             Payment?
  review              Review?

  @@map("appointments")
}

model CancellationRequest {
  id            String      @id @default(uuid())
  appointmentId String      @unique
  status        String
  reason        String?
  createdAt     DateTime    @default(now())
  processedAt   DateTime?
  processedById String?
  appointment   Appointment @relation(fields: [appointmentId], references: [id])

  @@map("cancellation_requests")
}

model Payment {
  id            String         @id @default(uuid())
  appointmentId String         @unique
  clinicId      String
  doctorId      String
  gatewayId     String
  amount        Decimal
  status        PaymentStatus
  gatewayRefId  String?
  createdAt     DateTime       @default(now())
  appointment   Appointment    @relation(fields: [appointmentId], references: [id])
  clinic        Clinic         @relation(fields: [clinicId], references: [id])
  doctor        Doctor         @relation(fields: [doctorId], references: [id])
  gateway       PaymentGateway @relation(fields: [gatewayId], references: [id])

  @@map("payments")
}

model AppointmentLog {
  id            String      @id @default(uuid())
  appointmentId String
  oldDate       DateTime
  oldTime       String
  newDate       DateTime
  newTime       String
    metadata      Json?  
  reason        String?
  changedBy     String
  createdAt     DateTime    @default(now())
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@map("appointment_logs")
}

model Review {
  id            String      @id @default(uuid())
  appointmentId String      @unique
  doctorId      String
  userId        String
  rating        Int
  comment       String?
  createdAt     DateTime    @default(now())
  deletedAt     DateTime?
  appointment   Appointment @relation(fields: [appointmentId], references: [id])
  doctor        Doctor      @relation(fields: [doctorId], references: [id])
  user          User        @relation(fields: [userId], references: [id])

  @@map("reviews")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  entity    String
  entityId  String?
  details   Json?
  ipAddress String?
  createdAt DateTime @default(now())
  clinicId  String?
  clinic    Clinic?  @relation(fields: [clinicId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

model Notification {
  id        String           @id @default(uuid())
  clinicId  String
  type      NotificationType
  entityId  String
  message   String
  createdAt DateTime         @default(now())
  readAt    DateTime?

  @@index([clinicId, type, readAt])
  @@index([clinicId, readAt])
}

enum NotificationType {
  CANCELLATION
  RESCHEDULE
  CANCEL_REQUEST
}

enum Role {
  SUPER_ADMIN
  ADMIN
  DOCTOR
  USER
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
  PENDING_PAYMENT
}

enum SlotType {
  FREE
  PAID
}

enum CancellationActor {
  USER
  ADMIN
}

enum SlotPaymentMode {
  ONLINE
  OFFLINE
  FREE
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  CANCELLED
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  TRIAL
}

model Speciality {
  id          String   @id @default(uuid())
  name        String   @unique  // e.g. "Dentist", "Cardiologist"
  description String?
  isActive    Boolean  @default(true)
  
  doctors     Doctor[] // Relation to doctors

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("specialities")
}

enum BookingSection {
  DENTAL
  CARDIAC
  NEUROLOGY
  ORTHOPEDICS
  GYNECOLOGY
  PEDIATRICS
  DERMATOLOGY
  OPHTHALMOLOGY
  GENERAL
  OTHER
}
